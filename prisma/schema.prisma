// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== Enums =====

enum Role {
  OWNER
  ADMIN
  MEMBER
}

enum Plan {
  FREE
  PRO
}

// /// Stage 2: project status for CRM
enum ProjectStatus {
  LEAD
  PROPOSAL_SENT
  WON
  LOST
}

// /// Stage 3: proposal lifecycle
enum ProposalStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
}

// ===== Models =====

// App-level user (backed by Clerk)
model User {
  id           String        @id @default(cuid())
  clerkUserId  String        @unique
  email        String

  memberships  Membership[]
  documents    Document[]    // generated documents by this user
  templates    Template[]    // templates created by this user (optional)

  // Stage 2: projects owned by this user
  ownedProjects Project[]

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

// One tenant workspace / org (like "Acme Inc")
model Organization {
  id            String          @id @default(cuid())
  name          String

  memberships   Membership[]
  subscription  Subscription?
  usageRecords  UsageRecord[]

  documents     Document[]      // all documents for this org
  templates     Template[]      // all templates for this org

  // Stage 2: CRM
  clients       Client[]
  projects      Project[]

  // Stage 3: proposals
  proposals     Proposal[]

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

// Which user is in which org, and with what role
model Membership {
  id        String        @id @default(cuid())

  userId    String
  orgId     String
  role      Role          @default(MEMBER)

  user      User          @relation(fields: [userId], references: [id])
  org       Organization  @relation(fields: [orgId], references: [id])

  createdAt DateTime      @default(now())
}

// Billing/subscription info for the org
model Subscription {
  id                   String         @id @default(cuid())

  orgId                String         @unique
  org                  Organization   @relation(fields: [orgId], references: [id])

  plan                 Plan           @default(FREE)
  stripeCustomerId     String?
  stripeSubscriptionId String?
  currentPeriodEnd     DateTime?      // end of current Stripe billing cycle

  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
}

// Monthly AI usage per org (used for Free limit / Pro unlimited)
model UsageRecord {
  id           String        @id @default(cuid())

  orgId        String
  org          Organization  @relation(fields: [orgId], references: [id])

  month        String        // "2025-10" (YYYY-MM)
  generations  Int           @default(0)

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@unique([orgId, month])
}

// ===== Stage 2: New Models for Clients & Projects =====

model Client {
  id            String        @id @default(cuid())

  orgId         String
  org           Organization  @relation(fields: [orgId], references: [id])

  name          String
  company       String?
  contactEmail  String?
  estimatedValue Int?
  notes         String?

  projects      Project[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model Project {
  id            String        @id @default(cuid())

  orgId         String
  org           Organization  @relation(fields: [orgId], references: [id])

  clientId      String
  client        Client        @relation(fields: [clientId], references: [id])

  ownerId       String?
  owner         User?         @relation(fields: [ownerId], references: [id])

  title         String
  status        ProjectStatus @default(LEAD)
  estimatedValue Int?
  lastActivityAt DateTime?

  // Stage 3: proposals for this project
  proposals     Proposal[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

// ===== Stage 3: Proposals =====

model Proposal {
  id        String          @id @default(cuid())

  projectId String
  project   Project         @relation(fields: [projectId], references: [id])

  orgId     String
  org       Organization    @relation(fields: [orgId], references: [id])

  version   Int             @default(1)
  status    ProposalStatus  @default(DRAFT)

  // structured sections: { overview, scope, deliverables, timeline, pricing }
  sections  Json

  publicToken String?       // used later in Stage 4 for shareable links

  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@index([projectId])
  @@index([orgId])
}

// ===== Existing Models for Proposal Copilot & Templates =====

// Stored outputs for proposals / scopes / follow-up emails, per org & user
model Document {
  id        String        @id @default(cuid())

  orgId     String
  userId    String

  org       Organization  @relation(fields: [orgId], references: [id])
  user      User          @relation(fields: [userId], references: [id])

  // e.g. "PROPOSAL" | "SCOPE" | "FOLLOW_UP" (we'll use string for flexibility)
  type      String
  title     String
  content   String

  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

// Org-level templates for proposals / scopes / emails
model Template {
  id        String        @id @default(cuid())

  orgId     String
  createdBy String?       // optional: user who created it

  org       Organization  @relation(fields: [orgId], references: [id])
  user      User?         @relation(fields: [createdBy], references: [id])

  // e.g. "PROPOSAL" | "SCOPE" | "FOLLOW_UP"
  type      String
  name      String
  body      String        // base prompt / template body

  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

